<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">



  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="IntroductionThis note is about installation of k8s cluster with kubeadm Environment ubuntu 22.04 containerd: 1.5.10 k8s v1.22.7 calico 3.22 nginx-ingress">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s cluster installation with kubeadm">
<meta property="og:url" content="http://example.com/2022/02/06/k8s/index.html">
<meta property="og:site_name" content="Yuanjing&#39;s Blog">
<meta property="og:description" content="IntroductionThis note is about installation of k8s cluster with kubeadm Environment ubuntu 22.04 containerd: 1.5.10 k8s v1.22.7 calico 3.22 nginx-ingress">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-02-06T19:53:38.000Z">
<meta property="article:modified_time" content="2022-11-20T20:19:19.692Z">
<meta property="article:author" content="Yuanjing Liu">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="container">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2022/02/06/k8s/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/02/06/k8s/","path":"2022/02/06/k8s/","title":"k8s cluster installation with kubeadm"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s cluster installation with kubeadm | Yuanjing's Blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Yuanjing's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">10</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">3</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">10</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Environment"><span class="nav-number">2.</span> <span class="nav-text">Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basic-package-installation"><span class="nav-number">3.</span> <span class="nav-text">Basic package installation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Setup-the-cluster"><span class="nav-number">4.</span> <span class="nav-text">Setup the cluster</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshot-setup-k8s"><span class="nav-number">5.</span> <span class="nav-text">Troubleshot setup k8s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Reset-k8s-cluster"><span class="nav-number">5.1.</span> <span class="nav-text">Reset k8s cluster</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deploy-networkplugin"><span class="nav-number">6.</span> <span class="nav-text">Deploy networkplugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshot-networkplugin"><span class="nav-number">7.</span> <span class="nav-text">Troubleshot networkplugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reset-networkplugin"><span class="nav-number">8.</span> <span class="nav-text">Reset networkplugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Troubleshot-gpu-node"><span class="nav-number">9.</span> <span class="nav-text">Troubleshot gpu node</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-gpu-job"><span class="nav-number">10.</span> <span class="nav-text">Test gpu job</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-with-Docker"><span class="nav-number">11.</span> <span class="nav-text">Install with Docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-kubeconfig-based-on-service-account"><span class="nav-number">12.</span> <span class="nav-text">Create kubeconfig based on service account</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">13.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yuanjing Liu"
      src="/images/luck.jpg">
  <p class="site-author-name" itemprop="name">Yuanjing Liu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/06/k8s/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/luck.jpg">
      <meta itemprop="name" content="Yuanjing Liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuanjing's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s cluster installation with kubeadm
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-06 19:53:38" itemprop="dateCreated datePublished" datetime="2022-02-06T19:53:38+00:00">2022-02-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-11-20 20:19:19" itemprop="dateModified" datetime="2022-11-20T20:19:19+00:00">2022-11-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>23 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This note is about installation of k8s cluster with kubeadm</p>
<h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><ul>
<li>ubuntu 22.04</li>
<li>containerd: 1.5.10</li>
<li>k8s v1.22.7<ul>
<li>calico 3.22</li>
<li>nginx-ingress</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h2 id="Basic-package-installation"><a href="#Basic-package-installation" class="headerlink" title="Basic package installation"></a>Basic package installation</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">CONTAINERD_VERSION=1.5.10</span><br><span class="line">K8S_VERSION=1.22.7-00</span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic environment</span></span><br><span class="line">sudo apt-get install vim bridge-utils ebtables -y</span><br><span class="line"><span class="comment">## disable firewall</span></span><br><span class="line">sudo ufw <span class="built_in">disable</span></span><br><span class="line"><span class="comment">## disable swap</span></span><br><span class="line">sudo swapoff -a</span><br><span class="line">sudo modprobe nf_tables</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment">## enable forwarding</span></span><br><span class="line">sudo cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sudo sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## ipvs</span></span><br><span class="line">sudo apt-get install ipvsadm ipset -y</span><br><span class="line">find /lib/modules/$(uname -r)/ -iname <span class="string">&quot;**.ko*&quot;</span> | cut -d/ -f5-|grep ip_vs</span><br><span class="line"></span><br><span class="line"><span class="comment">## ntp</span></span><br><span class="line">sudo apt-get install chrony -y</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> chrony --now</span><br><span class="line"></span><br><span class="line"><span class="comment">## other required packages</span></span><br><span class="line">sudo apt-get install -y \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg-agent \</span><br><span class="line">    software-properties-common</span><br><span class="line"></span><br><span class="line"><span class="comment">## cehck if libseccomp2 is installed</span></span><br><span class="line">dpkg --list | grep libseccomp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install Containerd</span></span><br><span class="line">wget https://github.com/containerd/containerd/releases/download/v<span class="variable">$&#123;CONTAINERD_VERSION&#125;</span>/cri-containerd-cni-<span class="variable">$&#123;CONTAINERD_VERSION&#125;</span>-linux-amd64.tar.gz</span><br><span class="line">sudo tar --no-overwrite-dir -C / -xzf cri-containerd-cni-<span class="variable">$&#123;CONTAINERD_VERSION&#125;</span>-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">sudo mkdir -p /etc/containerd &amp;&amp; sudo containerd config default | sudo sed -r -e <span class="string">&quot;s@SystemdCgroup = false@SystemdCgroup = true@g&quot;</span> | sudo tee /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now containerd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install kubeadm, kubelet, kubectl</span></span><br><span class="line">sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line">sudo apt-get update \</span><br><span class="line">   &amp;&amp; sudo apt-get install -y -q kubelet=<span class="variable">$&#123;K8S_VERSION&#125;</span> kubectl=<span class="variable">$&#123;K8S_VERSION&#125;</span> kubeadm=<span class="variable">$&#123;K8S_VERSION&#125;</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>

<p>For GPU worker node, install nvidia-container-toolkit, </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> $ID<span class="variable">$VERSION_ID</span>) \</span><br><span class="line">    &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/gpgkey | sudo apt-key add - \</span><br><span class="line">    &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/<span class="variable">$distribution</span>/libnvidia-container.list | sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list</span><br><span class="line"></span><br><span class="line">sudo apt-get update \</span><br><span class="line">    &amp;&amp; sudo apt-get install -y nvidia-container-toolkit</span><br></pre></td></tr></table></figure>

<p>and add the following in containerd config.toml to support nvidia-container-runtime</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">+            SystemdCgroup = <span class="literal">true</span></span><br><span class="line">+       [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.nvidia]</span><br><span class="line">+          privileged_without_host_devices = <span class="literal">false</span></span><br><span class="line">+          runtime_engine = <span class="string">&quot;&quot;</span></span><br><span class="line">+          runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line">+          runtime_type = <span class="string">&quot;io.containerd.runc.v1&quot;</span></span><br><span class="line">+          [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.nvidia.options]</span><br><span class="line">+            BinaryName = <span class="string">&quot;/usr/bin/nvidia-container-runtime&quot;</span></span><br><span class="line">+            SystemdCgroup = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>and change the default runtime from “runc” to “nvidia”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s/default_runtime_name = &quot;runc&quot;/default_runtime_name = &quot;nvidia&quot;/g&#x27;</span> /etc/containerd/config.toml</span><br><span class="line">sudo systemctl restart containerd</span><br></pre></td></tr></table></figure>
<p>Configure containerd to allow private registry with self-signed certificates</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs]</span><br><span class="line">               [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;private.registry.com:8080&quot;</span>.tls]</span><br><span class="line">                        insecure_skip_verify = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="Setup-the-cluster"><a href="#Setup-the-cluster" class="headerlink" title="Setup the cluster"></a>Setup the cluster</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start installation</span></span><br><span class="line"><span class="comment"># get initialization files, modify the master ip and add serviceSubnet, podSubnet accordingly, and master taint</span></span><br><span class="line">kubeadm config <span class="built_in">print</span> init-defaults --component-configs KubeletConfiguration &gt; kubeadmin.yaml</span><br><span class="line"><span class="comment"># check images should be used for initialization</span></span><br><span class="line">sudo kubeadm config images list --config kubeadmin.yaml</span><br><span class="line"><span class="comment"># images will be saved under containerd k8s.io ns</span></span><br><span class="line">sudo kubeadm config images pull --config kubeadmin.yaml </span><br><span class="line"><span class="comment"># initialize the cluster</span></span><br><span class="line">sudo kubeadm init --config kubeadmin.yaml --v 5</span><br><span class="line"><span class="comment"># join other nodes (invalid after 24h), regenerate command: sudo kubeadm token create --print-join-command</span></span><br><span class="line">kubeadm join master-ip:6443 --token abcdef.0123456789abcdef \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:8345453e3d08fb73e90d916adee187182cdb01af8c999ca0bd6f47e7d2089dee</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshot-setup-k8s"><a href="#Troubleshot-setup-k8s" class="headerlink" title="Troubleshot setup k8s"></a>Troubleshot setup k8s</h2><ul>
<li>if docker is installed, needs to edit kubelet configuration file /var/lib/kubelet/kubeadm-flags.env to add the following flags to KUBELET_KUBEADM_ARGS variable (adapt container-runtime-endpoint path if needed):<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">--container-runtime=remote --container-runtime-endpoint=/run/containerd/containerd.sock</span><br><span class="line"><span class="comment"># or </span></span><br><span class="line">sudo vim /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">Environment=<span class="string">&quot;KUBELET_EXTRA_ARGS=--container-runtime remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Reset-k8s-cluster"><a href="#Reset-k8s-cluster" class="headerlink" title="Reset k8s cluster"></a>Reset k8s cluster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm reset</span><br></pre></td></tr></table></figure>

<h2 id="Deploy-networkplugin"><a href="#Deploy-networkplugin" class="headerlink" title="Deploy networkplugin"></a>Deploy networkplugin</h2><p><a target="_blank" rel="noopener" href="https://www.cjavapy.com/article/2394/">https://www.cjavapy.com/article/2394/</a><br><a target="_blank" rel="noopener" href="https://www.teanote.pub/archives/300">https://www.teanote.pub/archives/300</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CALICO_VERSION=3.22</span><br><span class="line">curl https://docs.projectcalico.org/archive/v<span class="variable">$&#123;CALICO_VERSION&#125;</span>/manifests/calico.yaml -O calico.yaml</span><br><span class="line"><span class="comment"># check images needed</span></span><br><span class="line">grep image calico.yaml</span><br><span class="line"><span class="comment"># modify calico.yaml (k8s podSubnet, and modify the network interface)</span></span><br><span class="line">- name: CALICO_IPV4POOL_CIDR</span><br><span class="line"> value: <span class="string">&quot;192.168.0.0/16&quot;</span> </span><br><span class="line">- name: IP_AUTODETECTION_METHOD</span><br><span class="line">  value: <span class="string">&quot;interface=eth0&quot;</span></span><br><span class="line"><span class="comment"># do not let networkmanager to manage calico</span></span><br><span class="line">cat &lt;&lt;<span class="string">EOF&gt;&gt; /etc/NetworkManager/conf.d/calico.conf</span></span><br><span class="line"><span class="string">[keyfile]</span></span><br><span class="line"><span class="string">unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply bgp</span></span><br><span class="line">kubectl apply -f calico_3_22_bgp.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># apply vxlan</span></span><br><span class="line">kubectl apply -f calico_3_22_vxlan.yaml</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshot-networkplugin"><a href="#Troubleshot-networkplugin" class="headerlink" title="Troubleshot networkplugin"></a>Troubleshot networkplugin</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">default ip route :</span><br><span class="line"></span><br><span class="line">default via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.4 metric 100 </span><br><span class="line">10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.4 </span><br><span class="line">168.63.129.16 via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.4 metric 100 </span><br><span class="line">169.254.169.254 via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.4 metric 100 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown </span><br><span class="line">172.18.0.0/16 dev br-e468dacf0271 proto kernel scope link src 172.18.0.1 linkdown</span><br><span class="line"></span><br><span class="line">calico_vxlan ip route:</span><br><span class="line"></span><br><span class="line">default via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.5 metric 100 </span><br><span class="line">10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.5 </span><br><span class="line">168.63.129.16 via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.5 metric 100 </span><br><span class="line">169.254.169.254 via 10.0.2.1 dev eth0 proto dhcp src 10.0.2.5 metric 100 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown </span><br><span class="line">172.18.0.0/16 dev br-7420f731c7b2 proto kernel scope link src 172.18.0.1 linkdown </span><br><span class="line">blackhole 192.168.27.0/26 proto 80 </span><br><span class="line">192.168.27.1 dev cali351751788c1 scope link </span><br><span class="line">192.168.27.2 dev cali6212a2caaa0 scope link </span><br><span class="line">192.168.27.3 dev calid0c10cbe515 scope link </span><br><span class="line">192.168.214.0/26 via 192.168.214.0 dev vxlan.calico onlink</span><br></pre></td></tr></table></figure>

<h2 id="Reset-networkplugin"><a href="#Reset-networkplugin" class="headerlink" title="Reset networkplugin"></a>Reset networkplugin</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flannel</span></span><br><span class="line">sudo ifconfig cni0 down &amp;&amp; sudo ip link delete cni0</span><br><span class="line">sudo ifconfig flannel.1 down &amp;&amp; sudo ip link delete flannel.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># calico vxlan</span></span><br><span class="line">sudo ifconfig vxlan.calico down &amp;&amp; sudo ip link delete vxlan.calico</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove extra ip links</span></span><br><span class="line">sudo rm -rf /var/lib/cni/</span><br><span class="line"></span><br><span class="line">sudo ip route del xx</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove network files</span></span><br><span class="line">sudo mv /etc/cni/net.d/10-containerd-net.conflist /etc/cni/net.d/10-containerd-net.conflist.bk</span><br><span class="line">sudo mv /etc/cni/net.d/10-flannel.conflist /etc/cni/net.d/10-flannel.conflist.bk</span><br><span class="line">sudo mv /etc/cni/net.d/10-calico.conflist /etc/cni/net.d/10-calico.conflist.bk</span><br><span class="line">sudo rm -rf /etc/cni/net.d/calico-kubeconfig</span><br></pre></td></tr></table></figure>

<h2 id="Troubleshot-gpu-node"><a href="#Troubleshot-gpu-node" class="headerlink" title="Troubleshot gpu node"></a>Troubleshot gpu node</h2><p>Failed to initialize NVML: Driver/library version mismatch</p>
<p>yj@gpu01:<del>$ cat /proc/driver/nvidia/version<br>NVRM version: NVIDIA UNIX x86_64 Kernel Module  510.47.03  Mon Jan 24 22:58:54 UTC 2022<br>GCC version:  gcc version 9.4.0 (Ubuntu 9.4.0-1ubuntu1</del>20.04.1) </p>
<p>yj@gpu01:~$ dpkg -l | grep -i nvidia<br>ii  libnvidia-cfg1-510-server:amd64       510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA binary OpenGL/GLX configuration library<br>ii  libnvidia-common-510-server           510.73.08-0ubuntu0.20.04.1         all          Shared files used by the NVIDIA libraries<br>ii  libnvidia-compute-510-server:amd64    510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA libcompute package<br>ii  libnvidia-container-tools             1.9.0-1                            amd64        NVIDIA container runtime library (command-line tools)<br>ii  libnvidia-container1:amd64            1.9.0-1                            amd64        NVIDIA container runtime library<br>ii  libnvidia-decode-510-server:amd64     510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA Video Decoding runtime libraries<br>ii  libnvidia-encode-510-server:amd64     510.73.08-0ubuntu0.20.04.1         amd64        NVENC Video Encoding runtime library<br>ii  libnvidia-extra-510-server:amd64      510.73.08-0ubuntu0.20.04.1         amd64        Extra libraries for the NVIDIA Server Driver<br>ii  libnvidia-fbc1-510-server:amd64       510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA OpenGL-based Framebuffer Capture runtime library<br>ii  libnvidia-gl-510-server:amd64         510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA OpenGL/GLX/EGL/GLES GLVND libraries and Vulkan ICD<br>ii  nvidia-compute-utils-510-server       510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA compute utilities<br>ii  nvidia-container-toolkit              1.9.0-1                            amd64        NVIDIA container runtime hook<br>ii  nvidia-dkms-510-server                510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA DKMS package<br>ii  nvidia-driver-510-server              510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA Server Driver metapackage<br>ii  nvidia-kernel-common-510-server       510.73.08-0ubuntu0.20.04.1         amd64        Shared files used with the kernel module<br>ii  nvidia-kernel-source-510-server       510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA kernel source package<br>ii  nvidia-utils-510-server               510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA Server Driver support binaries<br>ii  xserver-xorg-video-nvidia-510-server  510.73.08-0ubuntu0.20.04.1         amd64        NVIDIA binary Xorg driver</p>
<p>check if the driver has been upgraded (from 510.47.03 to 510.73.08)</p>
<p>yj@gpu01:~$ cat /var/log/dpkg.log|grep nvidia<br>2022-06-09 06:16:53 upgrade nvidia-driver-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status half-configured nvidia-driver-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status unpacked nvidia-driver-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status half-installed nvidia-driver-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status unpacked nvidia-driver-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 upgrade libnvidia-gl-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status half-configured libnvidia-gl-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status unpacked libnvidia-gl-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:16:53 status half-installed libnvidia-gl-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:05 status unpacked libnvidia-gl-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:05 upgrade nvidia-dkms-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:05 status half-configured nvidia-dkms-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 status unpacked nvidia-dkms-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 status half-installed nvidia-dkms-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 status unpacked nvidia-dkms-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 upgrade nvidia-kernel-source-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 status half-configured nvidia-kernel-source-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 status unpacked nvidia-kernel-source-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:08 status half-installed nvidia-kernel-source-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:09 status unpacked nvidia-kernel-source-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:09 upgrade nvidia-kernel-common-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:09 status half-configured nvidia-kernel-common-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:09 status unpacked nvidia-kernel-common-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:09 status half-installed nvidia-kernel-common-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status unpacked nvidia-kernel-common-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 upgrade libnvidia-decode-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status half-configured libnvidia-decode-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status unpacked libnvidia-decode-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status half-installed libnvidia-decode-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status unpacked libnvidia-decode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 upgrade libnvidia-compute-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status half-configured libnvidia-compute-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status unpacked libnvidia-compute-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:10 status half-installed libnvidia-compute-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked libnvidia-compute-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 upgrade libnvidia-extra-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-configured libnvidia-extra-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked libnvidia-extra-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-installed libnvidia-extra-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked libnvidia-extra-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 upgrade nvidia-compute-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-configured nvidia-compute-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked nvidia-compute-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-installed nvidia-compute-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked nvidia-compute-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 upgrade libnvidia-encode-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-configured libnvidia-encode-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked libnvidia-encode-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-installed libnvidia-encode-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked libnvidia-encode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 upgrade nvidia-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-configured nvidia-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status unpacked nvidia-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:14 status half-installed nvidia-utils-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked nvidia-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 upgrade xserver-xorg-video-nvidia-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-configured xserver-xorg-video-nvidia-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked xserver-xorg-video-nvidia-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-installed xserver-xorg-video-nvidia-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked xserver-xorg-video-nvidia-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 upgrade libnvidia-fbc1-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-configured libnvidia-fbc1-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked libnvidia-fbc1-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-installed libnvidia-fbc1-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked libnvidia-fbc1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 upgrade libnvidia-cfg1-510-server:amd64 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-configured libnvidia-cfg1-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked libnvidia-cfg1-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-installed libnvidia-cfg1-510-server:amd64 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status unpacked libnvidia-cfg1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 configure nvidia-kernel-common-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:15 status unpacked nvidia-kernel-common-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:15 status half-configured nvidia-kernel-common-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed nvidia-kernel-common-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure libnvidia-cfg1-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked libnvidia-cfg1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured libnvidia-cfg1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed libnvidia-cfg1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure libnvidia-compute-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked libnvidia-compute-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured libnvidia-compute-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed libnvidia-compute-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure libnvidia-gl-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked libnvidia-gl-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured libnvidia-gl-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed libnvidia-gl-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure nvidia-kernel-source-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked nvidia-kernel-source-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured nvidia-kernel-source-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed nvidia-kernel-source-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure nvidia-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked nvidia-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured nvidia-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed nvidia-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure libnvidia-fbc1-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked libnvidia-fbc1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured libnvidia-fbc1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed libnvidia-fbc1-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure xserver-xorg-video-nvidia-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked xserver-xorg-video-nvidia-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured xserver-xorg-video-nvidia-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed xserver-xorg-video-nvidia-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure libnvidia-decode-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked libnvidia-decode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured libnvidia-decode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed libnvidia-decode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure libnvidia-extra-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked libnvidia-extra-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured libnvidia-extra-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed libnvidia-extra-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure nvidia-compute-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked nvidia-compute-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured nvidia-compute-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status installed nvidia-compute-utils-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 configure nvidia-dkms-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:17:37 status unpacked nvidia-dkms-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:17:37 status half-configured nvidia-dkms-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 status installed nvidia-dkms-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 configure libnvidia-encode-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:18:35 status unpacked libnvidia-encode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 status half-configured libnvidia-encode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 status installed libnvidia-encode-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 configure nvidia-driver-510-server:amd64 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:18:35 status unpacked nvidia-driver-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 status half-configured nvidia-driver-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:18:35 status installed nvidia-driver-510-server:amd64 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 upgrade libnvidia-common-510-server:all 510.73.05-0ubuntu0.20.04.1 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 status half-configured libnvidia-common-510-server:all 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 status unpacked libnvidia-common-510-server:all 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 status half-installed libnvidia-common-510-server:all 510.73.05-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 status unpacked libnvidia-common-510-server:all 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 configure libnvidia-common-510-server:all 510.73.08-0ubuntu0.20.04.1 <none><br>2022-06-09 06:19:29 status unpacked libnvidia-common-510-server:all 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 status half-configured libnvidia-common-510-server:all 510.73.08-0ubuntu0.20.04.1<br>2022-06-09 06:19:29 status installed libnvidia-common-510-server:all 510.73.08-0ubuntu0.20.04.1</p>
<p>sudo reboot to sync<br>sudo apt-mark hold nvidia-driver-510</p>
<p>or disable update by<br>sudo vim /etc/apt/apt.conf.d/50unattended-upgrades</p>
<p>after reboot, cluster restarts automactically (prerequisites: enable docker, enable kubelet)</p>
<h2 id="Test-gpu-job"><a href="#Test-gpu-job" class="headerlink" title="Test gpu job"></a>Test gpu job</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exec into container</span></span><br><span class="line"><span class="comment"># pytorch</span></span><br><span class="line">import torch as torch</span><br><span class="line">torch.cuda.is_available()</span><br><span class="line">torch.cuda.current_device()</span><br><span class="line">torch.cuda.device(0)</span><br><span class="line">torch.cuda.device_count()</span><br><span class="line">torch.cuda.get_device_name(0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tensorflow</span></span><br><span class="line">from tensorflow.python.client import device_lib</span><br><span class="line">device_lib.list_local_devices()</span><br><span class="line">gpus = tf.config.experimental.list_physical_devices(<span class="string">&#x27;GPU&#x27;</span>)</span><br><span class="line">from tensorflow.python.client import device_lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># get all the devices</span></span><br><span class="line">local_device_protos = device_lib.list_local_devices()</span><br><span class="line"><span class="comment">#print(local_device_protos)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print only gpu</span></span><br><span class="line">[<span class="built_in">print</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> local_device_protos <span class="keyword">if</span> x.device_type == <span class="string">&#x27;GPU&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h2 id="Install-with-Docker"><a href="#Install-with-Docker" class="headerlink" title="Install with Docker"></a>Install with Docker</h2><p>daemon.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;graph&quot;</span>: <span class="string">&quot;/data/docker&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;default-runtime&quot;</span>: <span class="string">&quot;nvidia&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;runtimes&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;nvidia&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/usr/bin/nvidia-container-runtime&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;runtimeArgs&quot;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;log-driver&quot;</span>: <span class="string">&quot;json-file&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;private.registry.com:8080&quot;</span>],</span><br><span class="line">    <span class="attr">&quot;live-restore&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Create-kubeconfig-based-on-service-account"><a href="#Create-kubeconfig-based-on-service-account" class="headerlink" title="Create kubeconfig based on service account"></a>Create kubeconfig based on service account</h2><p>ceate a service account and bind a role</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system create serviceaccount &lt;service-account-name&gt;</span><br><span class="line">kubectl create clusterrolebinding &lt;clusterrole-binding-name&gt; --clusterrole=cluster-admin --serviceaccount=namespace_name:&lt;service-account-name&gt;</span><br></pre></td></tr></table></figure>
<p>check the created service account</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">soeren-cluster-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xxx-token-dg9k7</span></span><br></pre></td></tr></table></figure>

<p>Secret_name=<code>kubectl -n namespace_name get serviceaccount/&lt;service-account-name&gt; -o jsonpath=&#39;&#123;.secrets[0].name&#125;&#39;</code></p>
<p>TOKEN=<code>kubectl -n namespace_name get secret xxx-token-dg9k7 -o jsonpath=&#39;&#123;.data.token&#125;&#39;| base64 --decode</code></p>
<p>set the credentials in .kube/config</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl config set-credentials &lt;service-account-name&gt; --token=<span class="variable">$TOKEN</span></span><br><span class="line">kubectl config set-context context-name --user=&lt;service-account-name&gt; --cluster=kubernetes</span><br></pre></td></tr></table></figure>

<p>switch to that context</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config use-context  context-name</span><br></pre></td></tr></table></figure>


<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://containerd.io/docs/getting-started/">https://containerd.io/docs/getting-started/</a><br><a target="_blank" rel="noopener" href="https://dev.to/stack-labs/how-to-switch-container-runtime-in-a-kubernetes-cluster-1628">https://dev.to/stack-labs/how-to-switch-container-runtime-in-a-kubernetes-cluster-1628</a><br><a target="_blank" rel="noopener" href="https://mdnice.com/writing/3e3ec25bfa464049ae173c31a6d98cf8">https://mdnice.com/writing/3e3ec25bfa464049ae173c31a6d98cf8</a><br><a target="_blank" rel="noopener" href="https://www.i4k.xyz/article/Scarborought/107247296">https://www.i4k.xyz/article/Scarborought/107247296</a></p>
<p>calico<br><a target="_blank" rel="noopener" href="https://projectcalico.docs.tigera.io/archive/v3.22/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-50-nodes-or-less">https://projectcalico.docs.tigera.io/archive/v3.22/getting-started/kubernetes/self-managed-onprem/onpremises#install-calico-with-kubernetes-api-datastore-50-nodes-or-less</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ssgeek/p/13194687.html">https://www.cnblogs.com/ssgeek/p/13194687.html</a><br><a target="_blank" rel="noopener" href="https://github.com/projectcalico/calico/issues/2166">https://github.com/projectcalico/calico/issues/2166</a><br><a target="_blank" rel="noopener" href="https://github.com/projectcalico/calico/issues/2834">https://github.com/projectcalico/calico/issues/2834</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Christine-ting/p/12837250.html">https://www.cnblogs.com/Christine-ting/p/12837250.html</a><br><a target="_blank" rel="noopener" href="https://www.teanote.pub/archives/300">https://www.teanote.pub/archives/300</a><br><a target="_blank" rel="noopener" href="https://feisky.gitbooks.io/kubernetes/content/network/calico/calico.html">https://feisky.gitbooks.io/kubernetes/content/network/calico/calico.html</a></p>
<p>flannel<br><a target="_blank" rel="noopener" href="https://www.modb.pro/db/149337">https://www.modb.pro/db/149337</a></p>
<p>cni<br><a target="_blank" rel="noopener" href="https://ronaknathani.com/blog/2020/08/how-a-kubernetes-pod-gets-an-ip-address/">https://ronaknathani.com/blog/2020/08/how-a-kubernetes-pod-gets-an-ip-address/</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
              <a href="/tags/container/" rel="tag"><i class="fa fa-tag"></i> container</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/06/kubeflow/" rel="prev" title="kubeflow">
                  <i class="fa fa-chevron-left"></i> kubeflow
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/06/gitlab/" rel="next" title="gitlab">
                  gitlab <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuanjing Liu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Symbols count total: </span>
    <span title="Symbols count total">93k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">1:25</span>
  </span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
