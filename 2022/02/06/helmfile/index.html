<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">



  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="IntroductionHelmfile is a tool to manage helm charts. Instead of managing all the helm charts one by one, helmfile allows you to achieve that in one command with helmfile and a directory of chart valu">
<meta property="og:type" content="article">
<meta property="og:title" content="helmfile">
<meta property="og:url" content="http://example.com/2022/02/06/helmfile/index.html">
<meta property="og:site_name" content="Yuanjing&#39;s Blog">
<meta property="og:description" content="IntroductionHelmfile is a tool to manage helm charts. Instead of managing all the helm charts one by one, helmfile allows you to achieve that in one command with helmfile and a directory of chart valu">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-02-06T19:52:03.000Z">
<meta property="article:modified_time" content="2022-11-20T20:16:19.939Z">
<meta property="article:author" content="Yuanjing Liu">
<meta property="article:tag" content="helm">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="helm charts">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2022/02/06/helmfile/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/02/06/helmfile/","path":"2022/02/06/helmfile/","title":"helmfile"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>helmfile | Yuanjing's Blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Yuanjing's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">10</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">3</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">10</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Basics-of-helmfile"><span class="nav-number">2.</span> <span class="nav-text">Basics of helmfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helmfile-installation-and-cli"><span class="nav-number">3.</span> <span class="nav-text">helmfile installation and cli</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#advanced-configuration-nestated-states"><span class="nav-number">4.</span> <span class="nav-text">advanced configuration: nestated states</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helmfile-with-environment-management"><span class="nav-number">5.</span> <span class="nav-text">helmfile with environment management</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helmfile-with-secrets-management"><span class="nav-number">6.</span> <span class="nav-text">helmfile with secrets management</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helmfile-hook-and-kustomize"><span class="nav-number">7.</span> <span class="nav-text">helmfile hook and kustomize</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hook"><span class="nav-number">7.1.</span> <span class="nav-text">hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kustomize"><span class="nav-number">7.2.</span> <span class="nav-text">kustomize</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">8.</span> <span class="nav-text">References</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yuanjing Liu"
      src="/images/luck.jpg">
  <p class="site-author-name" itemprop="name">Yuanjing Liu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/06/helmfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/luck.jpg">
      <meta itemprop="name" content="Yuanjing Liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuanjing's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          helmfile
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-06 19:52:03" itemprop="dateCreated datePublished" datetime="2022-02-06T19:52:03+00:00">2022-02-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-11-20 20:16:19" itemprop="dateModified" datetime="2022-11-20T20:16:19+00:00">2022-11-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/helm/" itemprop="url" rel="index"><span itemprop="name">helm</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>10 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Helmfile is a <a target="_blank" rel="noopener" href="https://github.com/roboll/helmfile">tool</a> to manage helm charts. Instead of managing all the helm charts one by one, helmfile allows you to achieve that in one command with helmfile and a directory of chart value files.</p>
<p>This note will introdcue</p>
<ul>
<li>basics of helmfile</li>
<li>helmfile installation and cli</li>
<li>advanced configuration: nested states</li>
<li>helmfile with environment management</li>
<li>helmfile with secrets management</li>
</ul>
<span id="more"></span>

<h2 id="Basics-of-helmfile"><a href="#Basics-of-helmfile" class="headerlink" title="Basics of helmfile"></a>Basics of helmfile</h2><p>A basic and simple helmfile looks like</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">repositories:</span></span><br><span class="line"><span class="comment"># To use official &quot;stable&quot; charts a.k.a https://github.com/helm/charts/tree/master/stable</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">stable</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://charts.helm.sh/stable</span></span><br><span class="line"><span class="comment"># To use official &quot;incubator&quot; charts a.k.a https://github.com/helm/charts/tree/master/incubator</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">incubator</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://charts.helm.sh/incubator</span></span><br><span class="line"><span class="comment"># helm-git powered repository: You can treat any Git repository as a charts repository</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">polaris</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">git+https://github.com/reactiveops/polaris@deploy/helm?ref=master</span></span><br><span class="line"><span class="comment"># Advanced configuration: You can setup basic or tls auth and optionally enable helm OCI integration</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">roboll</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">http://roboll.io/charts</span></span><br><span class="line">  <span class="attr">certFile:</span> <span class="string">optional_client_cert</span></span><br><span class="line">  <span class="attr">keyFile:</span> <span class="string">optional_client_key</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">optional_username</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">optional_password</span></span><br><span class="line">  <span class="attr">oci:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">passCredentials:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># Advanced configuration: You can use a ca bundle to use an https repo</span></span><br><span class="line"><span class="comment"># with a self-signed certificate</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">insecure</span></span><br><span class="line">   <span class="attr">url:</span> <span class="string">https://charts.my-insecure-domain.com</span></span><br><span class="line">   <span class="attr">caFile:</span> <span class="string">optional_ca_crt</span></span><br><span class="line"><span class="comment"># Advanced configuration: You can skip the verification of TLS for an https repo</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">skipTLS</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://ss.my-insecure-domain.com</span></span><br><span class="line">  <span class="attr">skipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default values to set for args along with dedicated keys that can be set by contributors, cli args take precedence over these.</span></span><br><span class="line"><span class="comment"># In other words, unset values results in no flags passed to helm.</span></span><br><span class="line"><span class="comment"># See the helm usage (helm SUBCOMMAND -h) for more info on default values when those flags aren&#x27;t provided.</span></span><br><span class="line"><span class="attr">helmDefaults:</span></span><br><span class="line">  <span class="attr">kubeContext:</span> <span class="string">kube-context</span>          <span class="comment">#dedicated default key for kube-context (--kube-context)</span></span><br><span class="line">  <span class="attr">cleanupOnFail:</span> <span class="literal">false</span>               <span class="comment">#dedicated default key for helm flag --cleanup-on-fail</span></span><br><span class="line">  <span class="comment"># verify the chart before upgrading (only works with packaged charts not directories) (default false)</span></span><br><span class="line">  <span class="attr">verify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># wait for k8s resources via --wait. (default false)</span></span><br><span class="line">  <span class="attr">wait:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># if set and --wait enabled, will wait until all Jobs have been completed before marking the release as successful. It will wait for as long as --timeout (default false, Implemented in Helm3.5)</span></span><br><span class="line">  <span class="attr">waitForJobs:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># time in seconds to wait for any individual Kubernetes operation (like Jobs for hooks, and waits on pod/pvc/svc/deployment readiness) (default 300)</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">600</span></span><br><span class="line">  <span class="comment"># limit the maximum number of revisions saved per release. Use 0 for no limit. (default 10)</span></span><br><span class="line">  <span class="attr">historyMax:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The desired states of Helm releases.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Helmfile runs various helm commands to converge the current state in the live cluster to the desired state defined here.</span></span><br><span class="line"><span class="attr">releases:</span></span><br><span class="line">  <span class="comment"># Published chart example</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vault</span>                            <span class="comment"># name of this release</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">vault</span>                       <span class="comment"># target namespace</span></span><br><span class="line">    <span class="attr">createNamespace:</span> <span class="literal">true</span>                  <span class="comment"># helm 3.2+ automatically create release namespace (default true)</span></span><br><span class="line">    <span class="attr">labels:</span>                                <span class="comment"># Arbitrary key value pairs for filtering releases</span></span><br><span class="line">      <span class="attr">foo:</span> <span class="string">bar</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">roboll/vault-secret-manager</span>     <span class="comment"># the chart being installed to create this release, referenced by `repository/chart` syntax</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">~1.24.1</span>                       <span class="comment"># the semver of the chart. range constraint is supported</span></span><br><span class="line">    <span class="attr">installed:</span> &#123;&#123; <span class="string">.Values.vault.enabled</span> &#125;&#125;</span><br><span class="line">    <span class="attr">missingFileHandler:</span> <span class="string">Warn</span> <span class="comment"># set to either &quot;Error&quot; or &quot;Warn&quot;. &quot;Error&quot; instructs helmfile to fail when unable to find a values or secrets file. When &quot;Warn&quot;, it prints the file and continues.</span></span><br><span class="line">    <span class="comment"># Values files used for rendering the chart</span></span><br><span class="line">    <span class="attr">values:</span></span><br><span class="line">      <span class="comment"># Value files passed via --values</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vault.yaml</span></span><br><span class="line">      <span class="comment"># Inline values, passed via a temporary values file and --values, so that it doesn&#x27;t suffer from type issues like --set</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">address:</span> <span class="string">https://vault.example.com</span></span><br><span class="line">      <span class="comment"># Go template available in inline values and values files.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span></span><br><span class="line">          <span class="comment"># The end result is more or less YAML. So do `quote` to prevent number-like strings from accidentally parsed into numbers!</span></span><br><span class="line">          <span class="comment"># See https://github.com/roboll/helmfile/issues/608</span></span><br><span class="line">          <span class="attr">tag:</span> &#123;&#123; <span class="string">requiredEnv</span> <span class="string">&quot;IMAGE_TAG&quot;</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">          <span class="comment"># Otherwise:</span></span><br><span class="line">          <span class="comment">#   tag: &quot;&#123;&#123; requiredEnv &quot;IMAGE_TAG&quot; &#125;&#125;&quot;</span></span><br><span class="line">          <span class="comment">#   tag: !!string &#123;&#123; requiredEnv &quot;IMAGE_TAG&quot; &#125;&#125;</span></span><br><span class="line">        <span class="attr">db:</span></span><br><span class="line">          <span class="attr">username:</span> &#123;&#123; <span class="string">requiredEnv</span> <span class="string">&quot;DB_USERNAME&quot;</span> &#125;&#125;</span><br><span class="line">          <span class="comment"># value taken from environment variable. Quotes are necessary. Will throw an error if the environment variable is not set. $DB_PASSWORD needs to be set in the calling environment ex: export DB_PASSWORD=&#x27;password1&#x27;</span></span><br><span class="line">          <span class="attr">password:</span> &#123;&#123; <span class="string">requiredEnv</span> <span class="string">&quot;DB_PASSWORD&quot;</span> &#125;&#125;</span><br><span class="line">        <span class="attr">proxy:</span></span><br><span class="line">          <span class="comment"># Interpolate environment variable with a fixed string</span></span><br><span class="line">          <span class="attr">domain:</span> &#123;&#123; <span class="string">requiredEnv</span> <span class="string">&quot;PLATFORM_ID&quot;</span> &#125;&#125;<span class="string">.my-domain.com</span></span><br><span class="line">          <span class="attr">scheme:</span> &#123;&#123; <span class="string">env</span> <span class="string">&quot;SCHEME&quot;</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;https&quot;</span> &#125;&#125;</span><br><span class="line">    <span class="comment"># Use `values` whenever possible!</span></span><br><span class="line">    <span class="comment"># `set` translates to helm&#x27;s `--set key=val`, that is known to suffer from type issues like https://github.com/roboll/helmfile/issues/608</span></span><br><span class="line">    <span class="attr">set:</span></span><br><span class="line">    <span class="comment"># single value loaded from a local file, translates to --set-file foo.config=path/to/file</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo.config</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">path/to/file</span></span><br><span class="line">    <span class="comment"># set a single array value in an array, translates to --set bar[0]=&#123;1,2&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">bar[0]</span></span><br><span class="line">      <span class="attr">values:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># set a templated value</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">      <span class="attr">value:</span> &#123;&#123; <span class="string">.Namespace</span> &#125;&#125;</span><br><span class="line">    <span class="comment"># will attempt to decrypt it using helm-secrets plugin</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">vault_secret.yaml</span></span><br><span class="line">    <span class="attr">kubeContext:</span> <span class="string">kube-context</span></span><br><span class="line">  <span class="comment"># Local chart example</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span>                            <span class="comment"># name of this release</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">another</span>                       <span class="comment"># target namespace</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">../my-charts/grafana</span>              <span class="comment"># the chart being installed to create this release, referenced by relative path to local helmfile</span></span><br><span class="line">    <span class="attr">values:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;../../my-values/grafana/values.yaml&quot;</span>             <span class="comment"># Values file (relative path to manifest)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./values/&#123;&#123;</span> <span class="string">requiredEnv</span> <span class="string">&quot;PLATFORM_ENV&quot;</span> <span class="string">&#125;&#125;/config.yaml</span> <span class="comment"># Values file taken from path with environment variable. $PLATFORM_ENV must be set in the calling environment.</span></span><br><span class="line">    <span class="attr">wait:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The basic helmfile includes 3 parts</p>
<ul>
<li>repositories: public helm chart repositories</li>
<li>helmDefaults: default configurations for helmfile command</li>
<li>releases: definition of helm chart deploy (local chart and registry chart)</li>
</ul>
<h2 id="helmfile-installation-and-cli"><a href="#helmfile-installation-and-cli" class="headerlink" title="helmfile installation and cli"></a>helmfile installation and cli</h2><p>For installation</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://github.com/roboll/helmfile/releases/download/v0.143.0/helmfile_linux_amd64 -o /usr/bin/helmfile</span><br><span class="line">$ chmod +x helmfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note, helm and helm plugins: helm-diff should be installed </span></span><br></pre></td></tr></table></figure>

<p>Some frequently used commands</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ helmfile -f helmfile.yaml diff</span><br><span class="line">$ helmfile -f helmfile.yaml apply</span><br><span class="line">$ helmfile -f helmfile.yaml sync</span><br><span class="line">$ helmfile -f helmfile.yaml destroy</span><br></pre></td></tr></table></figure>

<h2 id="advanced-configuration-nestated-states"><a href="#advanced-configuration-nestated-states" class="headerlink" title="advanced configuration: nestated states"></a>advanced configuration: nestated states</h2><p>nested states allows you to classify your releases in different helmfiles and manage all with one single helmfile.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Advanced Configuration: Nested States</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="attr">helmfiles:</span></span><br><span class="line"><span class="bullet">-</span> <span class="comment"># Path to the helmfile state file being processed BEFORE releases in this state file</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">path/to/subhelmfile.yaml</span></span><br><span class="line">  <span class="comment"># Label selector used for filtering releases in the nested state.</span></span><br><span class="line">  <span class="comment"># For example, `name=prometheus` in this context is equivalent to processing the nested state like</span></span><br><span class="line">  <span class="comment">#   helmfile -f path/to/subhelmfile.yaml -l name=prometheus sync</span></span><br><span class="line">  <span class="attr">selectors:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">name=prometheus</span></span><br><span class="line">  <span class="comment"># Override state values</span></span><br><span class="line">  <span class="attr">values:</span></span><br><span class="line">  <span class="comment"># Values files merged into the nested state&#x27;s values</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">additional.values.yaml</span></span><br><span class="line">  <span class="comment"># One important aspect of using values here is that they first need to be defined in the values section</span></span><br><span class="line">  <span class="comment"># of the origin helmfile, so in this example key1 needs to be in the values or environments.NAME.values of path/to/subhelmfile.yaml</span></span><br><span class="line">  <span class="comment"># Inline state values merged into the nested state&#x27;s values</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key1:</span> <span class="string">val1</span></span><br><span class="line"><span class="bullet">-</span> <span class="comment"># All the nested state files under `helmfiles:` is processed in the order of definition.</span></span><br><span class="line">  <span class="comment"># So it can be used for preparation for your main `releases`. An example would be creating CRDs required by `releases` in the parent state file.</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">path/to/mycrd.helmfile.yaml</span></span><br><span class="line"><span class="bullet">-</span> <span class="comment"># Terraform-module-like URL for importing a remote directory and use a file in it as a nested-state file</span></span><br><span class="line">  <span class="comment"># The nested-state file is locally checked-out along with the remote directory containing it.</span></span><br><span class="line">  <span class="comment"># Therefore all the local paths in the file are resolved relative to the file</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">git::https://github.com/cloudposse/helmfiles.git@releases/kiam.yaml?ref=0.40.0</span></span><br><span class="line"><span class="comment"># If set to &quot;Error&quot;, return an error when a subhelmfile points to a</span></span><br><span class="line"><span class="comment"># non-existent path. The default behavior is to print a warning and continue.</span></span><br><span class="line"><span class="attr">missingFileHandler:</span> <span class="string">Error</span></span><br></pre></td></tr></table></figure>

<p>Under helmfiles, all the independent sub helmfiles are included via it’s path, and we could pass the values file and select the release from the sub helmfile to be executed</p>
<h2 id="helmfile-with-environment-management"><a href="#helmfile-with-environment-management" class="headerlink" title="helmfile with environment management"></a>helmfile with environment management</h2><p>We could also manage the deployment with different environment values files. Environment Values allows you to inject a set of values specific to the selected environment, into values.yaml.gotml templates. </p>
<p>e.g., <code>helmfile -f helmfile.yaml -e dev01 apply</code></p>
<p>The helmfile.yaml is configured with different environment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The list of environments managed by helmfile.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The default is `environments: &#123;&quot;default&quot;: &#123;&#125;&#125;` which implies:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># - `&#123;&#123; .Environment.Name &#125;&#125;` evaluates to &quot;default&quot;</span></span><br><span class="line"><span class="comment"># - `&#123;&#123; .Values &#125;&#125;` being empty</span></span><br><span class="line"><span class="attr">environments:</span></span><br><span class="line">  <span class="comment"># The &quot;default&quot; environment is available and used when `helmfile` is run without `--environment NAME`.</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="comment"># Everything from the values.yaml is available via `&#123;&#123; .Values.KEY &#125;&#125;`.</span></span><br><span class="line">    <span class="comment"># Suppose `&#123;&quot;foo&quot;: &#123;&quot;bar&quot;: 1&#125;&#125;` contained in the values.yaml below,</span></span><br><span class="line">    <span class="comment"># `&#123;&#123; .Values.foo.bar &#125;&#125;` is evaluated to `1`.</span></span><br><span class="line">    <span class="attr">values:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">environments/default/values.yaml</span></span><br><span class="line">    <span class="comment"># Each entry in values can be either a file path or inline values.</span></span><br><span class="line">    <span class="comment"># The below is an example of inline values, which is merged to the `.Values`</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">myChartVer:</span> <span class="number">1.0</span><span class="number">.0</span><span class="string">-dev</span></span><br><span class="line">  <span class="comment"># Any environment other than `default` is used only when `helmfile` is run with `--environment NAME`.</span></span><br><span class="line">  <span class="comment"># That is, the &quot;production&quot; env below is used when and only when it is run like `helmfile --environment production sync`.</span></span><br><span class="line">  <span class="attr">production:</span></span><br><span class="line">    <span class="attr">values:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">environments/production/values.yaml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">myChartVer:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">    <span class="comment"># disable vault release processing</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">vault:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment">## `secrets.yaml` is decrypted by `helm-secrets` and available via `&#123;&#123; .Environment.Values.KEY &#125;&#125;`</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">environments/production/secrets.yaml</span></span><br><span class="line">    <span class="comment"># Instructs helmfile to fail when unable to find a environment values file listed under `environments.NAME.values`.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Possible values are  &quot;Error&quot;, &quot;Warn&quot;, &quot;Info&quot;, &quot;Debug&quot;. The default is &quot;Error&quot;.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Use &quot;Warn&quot;, &quot;Info&quot;, or &quot;Debug&quot; if you want helmfile to not fail when a values file is missing, while just leaving</span></span><br><span class="line">    <span class="comment"># a message about the missing file at the log-level.</span></span><br><span class="line">    <span class="attr">missingFileHandler:</span> <span class="string">Error</span></span><br><span class="line">    <span class="comment"># kubeContext to use for this environment</span></span><br><span class="line">    <span class="attr">kubeContext:</span> <span class="string">kube-context</span></span><br><span class="line"><span class="attr">releases:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">chart:</span> <span class="string">myrepo/myapp</span></span><br><span class="line">  <span class="attr">values:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">values.yaml.gotmpl</span></span><br></pre></td></tr></table></figure>

<p><code>environment/xx/values.yaml</code> should contain values that could be fed into values.yaml.gotmpl</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">domain:</span> <span class="string">myapp.example.com</span></span><br><span class="line"><span class="attr">releaseName:</span> <span class="string">myapp</span></span><br></pre></td></tr></table></figure>

<p>in <code>values.yaml.gotmpl</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">domain:</span> &#123;&#123; <span class="string">.Values</span> <span class="string">|</span> <span class="string">get</span> <span class="string">&quot;domain&quot;</span> <span class="string">&quot;dev.example.com&quot;</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="helmfile-with-secrets-management"><a href="#helmfile-with-secrets-management" class="headerlink" title="helmfile with secrets management"></a>helmfile with secrets management</h2><p>In environment values, some sensitive variables should always be encrypted. Helmfile supports also secrets, the secrets parameter in a helmfile.yaml causes the helm-secrets plugin to be executed to decrypt the secrets.yaml file before rendering the templates. (helm plugin secrets should be installed to used this feature).</p>
<p>The secrets usage in helmfile is the same as in helm chart, a detailed introduction could be found in previous post about <a target="_blank" rel="noopener" href="https://naomilyj.github.io/2022/02/06/helmchart/">helm chart</a>.</p>
<h2 id="helmfile-hook-and-kustomize"><a href="#helmfile-hook-and-kustomize" class="headerlink" title="helmfile hook and kustomize"></a>helmfile hook and kustomize</h2><h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><p>A Helmfile hook is a per-release extension point that is composed of:</p>
<ul>
<li>events</li>
<li>command</li>
<li>args</li>
<li>showlogs</li>
</ul>
<p>Helmfile triggers various events while it is running. Once events are triggered, associated hooks are executed, by running the command with args. The standard output of the command will be displayed if showlogs is set and it’s value is true.</p>
<p>Currently supported events are:</p>
<ul>
<li>prepare</li>
<li>presync</li>
<li>preuninstall</li>
<li>postuninstall</li>
<li>postsync</li>
<li>cleanup</li>
</ul>
<h3 id="kustomize"><a href="#kustomize" class="headerlink" title="kustomize"></a>kustomize</h3><p>The way how helmfile could be used to manage kustomize manifests is based on hook. The preinstall hook will create a temp helm chart from rendered resources using kustomize command</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/roboll/helmfile">https://github.com/roboll/helmfile</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NaomiLYJ/helmfile-templates">https://github.com/NaomiLYJ/helmfile-templates</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/helm/" rel="tag"><i class="fa fa-tag"></i> helm</a>
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
              <a href="/tags/helm-charts/" rel="tag"><i class="fa fa-tag"></i> helm charts</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/02/06/helmchart/" rel="prev" title="helm charts">
                  <i class="fa fa-chevron-left"></i> helm charts
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/06/kubeflow/" rel="next" title="kubeflow">
                  kubeflow <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuanjing Liu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Symbols count total: </span>
    <span title="Symbols count total">93k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">1:25</span>
  </span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
