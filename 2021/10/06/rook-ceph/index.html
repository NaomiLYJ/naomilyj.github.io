<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">



  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.7.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="IntroductionThis note is about how to install ceph cluster in k8s cluster with rook-ceph  What are the preparations for the installation install with k8s manifests (release-1.3) How to install rook-ce">
<meta property="og:type" content="article">
<meta property="og:title" content="Install ceph with rook-ceph">
<meta property="og:url" content="http://example.com/2021/10/06/rook-ceph/index.html">
<meta property="og:site_name" content="Yuanjing&#39;s Blog">
<meta property="og:description" content="IntroductionThis note is about how to install ceph cluster in k8s cluster with rook-ceph  What are the preparations for the installation install with k8s manifests (release-1.3) How to install rook-ce">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-10-06T18:36:42.000Z">
<meta property="article:modified_time" content="2022-11-20T20:12:42.396Z">
<meta property="article:author" content="Yuanjing Liu">
<meta property="article:tag" content="cloud">
<meta property="article:tag" content="ceph">
<meta property="article:tag" content="rook-ceph">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2021/10/06/rook-ceph/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2021/10/06/rook-ceph/","path":"2021/10/06/rook-ceph/","title":"Install ceph with rook-ceph"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Install ceph with rook-ceph | Yuanjing's Blog</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Yuanjing's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">10</span></a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">3</span></a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">10</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Layout"><span class="nav-number">2.</span> <span class="nav-text">Layout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Preparation"><span class="nav-number">3.</span> <span class="nav-text">Preparation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#label-your-node-for-setup"><span class="nav-number">4.</span> <span class="nav-text">label your node for setup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-with-k8s-manifests"><span class="nav-number">5.</span> <span class="nav-text">Install with k8s manifests</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Install-Rook-Operator"><span class="nav-number">5.1.</span> <span class="nav-text">Install Rook Operator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-a-ceph-cluster"><span class="nav-number">5.2.</span> <span class="nav-text">Create a ceph cluster</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-with-helm-charts"><span class="nav-number">6.</span> <span class="nav-text">Install with helm charts</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#rook-ceph-chart"><span class="nav-number">6.1.</span> <span class="nav-text">rook-ceph chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rook-ceph-cluster-chart"><span class="nav-number">6.2.</span> <span class="nav-text">rook-ceph-cluster chart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Usage"><span class="nav-number">6.3.</span> <span class="nav-text">Usage</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CephFS"><span class="nav-number">6.3.1.</span> <span class="nav-text">CephFS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ceph-Object-Storage"><span class="nav-number">6.3.2.</span> <span class="nav-text">Ceph Object Storage</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#create-object-storage-service"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">create object storage service</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Deploy-MINIO-GUI-for-Ceph-Obkect-Storage"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">Deploy MINIO GUI for Ceph Obkect Storage</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cleanup-rook-ceph"><span class="nav-number">7.</span> <span class="nav-text">Cleanup rook-ceph</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trouble-shooting-ceph-installation"><span class="nav-number">8.</span> <span class="nav-text">Trouble shooting ceph installation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Usage-1"><span class="nav-number">9.</span> <span class="nav-text">Usage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-osd-pool-management"><span class="nav-number">9.1.</span> <span class="nav-text">ceph osd: pool management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-filesystem"><span class="nav-number">9.2.</span> <span class="nav-text">ceph filesystem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-osd-remove-a-osd-device"><span class="nav-number">9.3.</span> <span class="nav-text">ceph osd: remove a osd device</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-osd-add-a-new-osd"><span class="nav-number">9.4.</span> <span class="nav-text">ceph osd: add a new osd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-object-storage-data-pools"><span class="nav-number">9.5.</span> <span class="nav-text">ceph object storage: data pools</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-object-storage-multisite-management"><span class="nav-number">9.6.</span> <span class="nav-text">ceph object storage: multisite management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-object-storage-user-management"><span class="nav-number">9.7.</span> <span class="nav-text">ceph object storage: user management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-object-storage-bucket-policy"><span class="nav-number">9.8.</span> <span class="nav-text">ceph object storage: bucket policy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-dashboard"><span class="nav-number">9.9.</span> <span class="nav-text">ceph dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">10.</span> <span class="nav-text">References:</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yuanjing Liu"
      src="/images/luck.jpg">
  <p class="site-author-name" itemprop="name">Yuanjing Liu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/06/rook-ceph/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/luck.jpg">
      <meta itemprop="name" content="Yuanjing Liu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yuanjing's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Install ceph with rook-ceph
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-10-06 18:36:42" itemprop="dateCreated datePublished" datetime="2021-10-06T18:36:42+00:00">2021-10-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2022-11-20 20:12:42" itemprop="dateModified" datetime="2022-11-20T20:12:42+00:00">2022-11-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ceph/" itemprop="url" rel="index"><span itemprop="name">ceph</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Symbols count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Symbols count in article: </span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>22 mins.</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This note is about how to install ceph cluster in k8s cluster with rook-ceph</p>
<ul>
<li>What are the preparations for the installation</li>
<li>install with k8s manifests (release-1.3)</li>
<li>How to install rook-ceph with helm charts (v1.8.3)</li>
</ul>
<span id="more"></span>

<h2 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Environment</span></span><br><span class="line"><span class="comment"># k8s 1.22.7</span></span><br><span class="line"><span class="comment"># NAME            ROLES                 Disk</span></span><br><span class="line"><span class="comment"># node01          master, mon           /dev/sda</span></span><br><span class="line"><span class="comment"># node02          worker, mon           /dev/sdc</span></span><br><span class="line"><span class="comment"># node03          worker, mon           /dev/sdb</span></span><br></pre></td></tr></table></figure>

<h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><p>For installing ceph in k8s with rook, the follwing requirements should be fulfilled</p>
<ul>
<li>kubernetes &gt; v1.17.0</li>
<li>minimum 3 nodes of kubernetes cluster</li>
<li>disk  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. The device must have no partitions.</span><br><span class="line">2. The device must not have any LVM state.</span><br><span class="line">3. The device must not be mounted.</span><br><span class="line">4. The device must not contain a file system.</span><br><span class="line">5. The device must not contain a Ceph BlueStore OSD.</span><br><span class="line">6. The device must be larger than 5 GB.</span><br><span class="line"><span class="comment"># check with lsblk</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="label-your-node-for-setup"><a href="#label-your-node-for-setup" class="headerlink" title="label your node for setup"></a>label your node for setup</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ceph]<span class="comment"># kubectl taint node node01 node-role.kubernetes.io/master=&quot;&quot;:NoSchedule</span></span><br><span class="line"></span><br><span class="line">[root@node01 ceph]<span class="comment"># kubectl label nodes &#123;node01, node02, node03&#125; ceph-osd=enabled</span></span><br><span class="line"></span><br><span class="line">[root@node01 ceph]<span class="comment"># kubectl label nodes &#123;node01, node02, node03&#125; ceph-mon=enabled</span></span><br><span class="line"></span><br><span class="line">[root@node01 ceph]<span class="comment"># kubectl label nodes node01 ceph-mgr=enabled</span></span><br></pre></td></tr></table></figure>

<h2 id="Install-with-k8s-manifests"><a href="#Install-with-k8s-manifests" class="headerlink" title="Install with k8s manifests"></a>Install with k8s manifests</h2><h3 id="Install-Rook-Operator"><a href="#Install-Rook-Operator" class="headerlink" title="Install Rook Operator"></a>Install Rook Operator</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># download rook release 1.3</span></span><br><span class="line">$ git <span class="built_in">clone</span> --single-branch --branch release-1.3 https://github.com/rook/rook.git</span><br><span class="line"><span class="comment"># configuration files</span></span><br><span class="line">$ <span class="built_in">cd</span> rook/cluster/examples/kubernetes/ceph</span><br><span class="line"></span><br><span class="line">$ kubectl create -f common.yaml</span><br><span class="line">$ kubectl apply -f operator.yaml</span><br><span class="line"><span class="comment">## Output</span></span><br><span class="line">$ configmap/rook-ceph-operator-config created</span><br><span class="line">$ deployment.apps/rook-ceph-operator created</span><br><span class="line"></span><br><span class="line"><span class="comment"># check pods created in rook-ceph</span></span><br><span class="line">$ kubectl get pod -n rook-ceph</span><br><span class="line"><span class="comment">## Output</span></span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">rook-ceph-operator-599765ff49-fhbz9   1/1     Running   0          92s</span><br><span class="line">rook-discover-6fhlb                   1/1     Running   0          55s</span><br><span class="line">rook-discover-97kmz                   1/1     Running   0          55s</span><br><span class="line">rook-discover-z5k2z                   1/1     Running   0          55s</span><br></pre></td></tr></table></figure>

<h3 id="Create-a-ceph-cluster"><a href="#Create-a-ceph-cluster" class="headerlink" title="Create a ceph cluster"></a>Create a ceph cluster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apply cluster resource</span></span><br><span class="line">kubectl apply -f cephcluster.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## Output</span></span><br><span class="line">NAME                                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">csi-cephfsplugin-lz6dn                                 3/3     Running   0          3m54s</span><br><span class="line">csi-cephfsplugin-provisioner-674847b584-4j9jw          5/5     Running   0          3m54s</span><br><span class="line">csi-cephfsplugin-provisioner-674847b584-h2cgl          5/5     Running   0          3m54s</span><br><span class="line">csi-cephfsplugin-qbpnq                                 3/3     Running   0          3m54s</span><br><span class="line">csi-cephfsplugin-qzsvr                                 3/3     Running   0          3m54s</span><br><span class="line">csi-rbdplugin-kk9sw                                    3/3     Running   0          3m55s</span><br><span class="line">csi-rbdplugin-l95f8                                    3/3     Running   0          3m55s</span><br><span class="line">csi-rbdplugin-provisioner-64ccb796cf-8gjwv             6/6     Running   0          3m55s</span><br><span class="line">csi-rbdplugin-provisioner-64ccb796cf-dhpwt             6/6     Running   0          3m55s</span><br><span class="line">csi-rbdplugin-v4hk6                                    3/3     Running   0          3m55s</span><br><span class="line">rook-ceph-crashcollector-pool-33zy7-68cdfb6bcf-9cfkn   1/1     Running   0          109s</span><br><span class="line">rook-ceph-crashcollector-pool-33zyc-565559f7-7r6rt     1/1     Running   0          53s</span><br><span class="line">rook-ceph-crashcollector-pool-33zym-749dcdc9df-w4xzl   1/1     Running   0          78s</span><br><span class="line">rook-ceph-mgr-a-7fdf77cf8d-ppkwl                       1/1     Running   0          53s</span><br><span class="line">rook-ceph-mon-a-97d9767c6-5ftfm                        1/1     Running   0          109s</span><br><span class="line">rook-ceph-mon-b-9cb7bdb54-lhfkj                        1/1     Running   0          96s</span><br><span class="line">rook-ceph-mon-c-786b9f7f4b-jdls4                       1/1     Running   0          78s</span><br><span class="line">rook-ceph-operator-599765ff49-fhbz9                    1/1     Running   0          6m58s</span><br><span class="line">rook-ceph-osd-prepare-pool-33zy7-c2hww                 1/1     Running   0          21s</span><br><span class="line">rook-ceph-osd-prepare-pool-33zyc-szwsc                 1/1     Running   0          21s</span><br><span class="line">rook-ceph-osd-prepare-pool-33zym-2p68b                 1/1     Running   0          21s</span><br><span class="line">rook-discover-6fhlb                                    1/1     Running   0          6m21s</span><br><span class="line">rook-discover-97kmz                                    1/1     Running   0          6m21s</span><br><span class="line">rook-discover-z5k2z                                    1/1     Running   0          6m21s</span><br></pre></td></tr></table></figure>

<h2 id="Install-with-helm-charts"><a href="#Install-with-helm-charts" class="headerlink" title="Install with helm charts"></a>Install with helm charts</h2><p>There’re 2 charts (<a target="_blank" rel="noopener" href="https://github.com/rook/rook/tree/v1.8.3/deploy/charts">https://github.com/rook/rook/tree/v1.8.3/deploy/charts</a>)</p>
<ul>
<li>rook-ceph: install rook-operator resources</li>
<li>rook-ceph-cluster: install cluster resources</li>
</ul>
<h3 id="rook-ceph-chart"><a href="#rook-ceph-chart" class="headerlink" title="rook-ceph chart"></a>rook-ceph chart</h3><ul>
<li><p>update configurations in values.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allowMultipleFilesystems: <span class="literal">true</span></span><br><span class="line">hostpathRequiresPrivileged: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>apply installation</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade install rook-ceph -n rook-ceph -v v1.8.3 rook-release/rook-ceph -f values.yaml</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="rook-ceph-cluster-chart"><a href="#rook-ceph-cluster-chart" class="headerlink" title="rook-ceph-cluster chart"></a>rook-ceph-cluster chart</h3><ul>
<li><p>Modify the disk configuration in valuse.yaml according to your hardward disk setup. Make sure that the disks fulfill the requirements</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">    <span class="attr">useAllNodes:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">useAllDevices:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">nodes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;node01&quot;</span></span><br><span class="line">        <span class="attr">devices:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;sda&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;node02&quot;</span></span><br><span class="line">        <span class="attr">devices:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;sdc&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;node03&quot;</span></span><br><span class="line">        <span class="attr">devices:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;sdb&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>apply installation</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade install rook-ceph-cluster -n rook-ceph -v v1.8.3 rook-release/rook-ceph-cluster -f values.yaml</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><h4 id="CephFS"><a href="#CephFS" class="headerlink" title="CephFS"></a>CephFS</h4><ul>
<li><p>create file system (CephFilesystem and StorageClass)<br>Fill the templates accroding to your setup</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephFilesystem</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123;<span class="string">.Values.hddFS.name</span>&#125;&#125;</span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">metadataPool:</span></span><br><span class="line">    <span class="attr">replicated:</span></span><br><span class="line">      <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.hddFS.replicated</span>&#125;&#125;</span><br><span class="line">  <span class="attr">dataPools:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">replicated-&#123;&#123;.Values.hddFS.replicated&#125;&#125;</span></span><br><span class="line">      <span class="attr">replicated:</span></span><br><span class="line">        <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.hddFS.replicated</span>&#125;&#125;</span><br><span class="line">      <span class="attr">deviceClass:</span> <span class="string">hdd</span></span><br><span class="line">  <span class="attr">preserveFilesystemOnDelete:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metadataServer:</span></span><br><span class="line">    <span class="attr">activeCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">activeStandby:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123;<span class="string">.Values.hddFS.name</span>&#125;&#125;</span><br><span class="line"><span class="comment"># Change &quot;rook-ceph&quot; provisioner prefix to match the operator namespace if needed</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">rook-ceph.cephfs.csi.ceph.com</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="comment"># clusterID is the namespace where the rook cluster is running</span></span><br><span class="line">  <span class="comment"># If you change this namespace, also change the namespace below where the secret namespaces are defined</span></span><br><span class="line">  <span class="attr">clusterID:</span> <span class="string">rook-ceph</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># CephFS filesystem name into which the volume shall be created</span></span><br><span class="line">  <span class="attr">fsName:</span> &#123;&#123;<span class="string">.Values.hddFS.name</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Ceph pool into which the volume shall be created</span></span><br><span class="line">  <span class="comment"># Required for provisionVolume: &quot;true&quot;</span></span><br><span class="line">  <span class="attr">pool:</span> &#123;&#123;<span class="string">.Values.hddFS.name</span>&#125;&#125;<span class="string">-replicated-&#123;&#123;.Values.hddFS.replicated&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The secrets contain Ceph admin credentials. These are generated automatically by the operator</span></span><br><span class="line">  <span class="comment"># in the same namespace as the cluster.</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-name:</span> <span class="string">rook-csi-cephfs-provisioner</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/provisioner-secret-namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/controller-expand-secret-name:</span> <span class="string">rook-csi-cephfs-provisioner</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/controller-expand-secret-namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-stage-secret-name:</span> <span class="string">rook-csi-cephfs-node</span></span><br><span class="line">  <span class="attr">csi.storage.k8s.io/node-stage-secret-namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephFilesystem</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123;<span class="string">.Values.ssdFS.name</span>&#125;&#125;</span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">metadataPool:</span></span><br><span class="line">    <span class="attr">replicated:</span></span><br><span class="line">      <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.ssdFS.replicated</span>&#125;&#125;</span><br><span class="line">  <span class="attr">dataPools:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">replicated-&#123;&#123;.Values.ssdFS.replicated&#125;&#125;</span></span><br><span class="line">      <span class="attr">replicated:</span></span><br><span class="line">        <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.ssdFS.replicated</span>&#125;&#125;</span><br><span class="line">      <span class="attr">deviceClass:</span> <span class="string">ssd</span></span><br><span class="line">  <span class="attr">preserveFilesystemOnDelete:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metadataServer:</span></span><br><span class="line">    <span class="attr">activeCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">activeStandby:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>use the created file system in the current k8s cluster</p>
</li>
</ul>
<h4 id="Ceph-Object-Storage"><a href="#Ceph-Object-Storage" class="headerlink" title="Ceph Object Storage"></a>Ceph Object Storage</h4><h5 id="create-object-storage-service"><a href="#create-object-storage-service" class="headerlink" title="create object storage service"></a>create object storage service</h5><ul>
<li><p>object storage service without multisite settings (only one type of bucket, e.g., hdd)</p>
<ul>
<li>CephObjectStorage</li>
<li>StorageClass</li>
</ul>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephObjectStore</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="comment"># do not change it, pool name, </span></span><br><span class="line"><span class="comment"># pool will not be deleted even this resource is deleted</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.hdd.storeName</span>&#125;&#125;</span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">metadataPool:</span></span><br><span class="line">    <span class="attr">failureDomain:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">replicated:</span></span><br><span class="line">    <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.oss.hdd.replicated</span>&#125;&#125;</span><br><span class="line"><span class="attr">dataPool:</span></span><br><span class="line">    <span class="attr">failureDomain:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">replicated:</span></span><br><span class="line">    <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.oss.hdd.replicated</span>&#125;&#125;</span><br><span class="line">    <span class="attr">deviceClass:</span> <span class="string">hdd</span></span><br><span class="line">    <span class="comment">#erasureCoded:</span></span><br><span class="line">    <span class="comment">#  dataChunks: 2</span></span><br><span class="line">    <span class="comment">#  codingChunks: 1</span></span><br><span class="line"><span class="attr">preservePoolsOnDelete:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">sslCertificateRef:</span></span><br><span class="line">    <span class="attr">port:</span> &#123;&#123;<span class="string">.Values.oss.hdd.port</span>&#125;&#125;</span><br><span class="line">    <span class="comment"># securePort: 443</span></span><br><span class="line">    <span class="attr">instances:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">healthCheck:</span></span><br><span class="line">    <span class="attr">bucket:</span></span><br><span class="line">    <span class="attr">disabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">60s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.hdd.storageClassName</span>&#125;&#125;</span><br><span class="line"><span class="comment"># Change &quot;rook-ceph&quot; provisioner prefix to match the operator namespace if needed</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">rook-ceph.ceph.rook.io/bucket</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">objectStoreName:</span> &#123;&#123;<span class="string">.Values.oss.hdd.storeName</span>&#125;&#125;</span><br><span class="line"><span class="attr">objectStoreNamespace:</span> <span class="string">rook-ceph</span></span><br></pre></td></tr></table></figure></li>
<li><p>another object storage service with multisite settings (make good use of the crush rule to allow the creation of both ssd bucket and hdd bucket) </p>
<ul>
<li>CephObjectRealm</li>
<li>CephObjectZoneGroup</li>
<li>CephObjectZone</li>
<li>CephObjectStorage</li>
<li>StorageClass</li>
<li>Service</li>
<li>Ingress<br>Fill the templates accroding to your setup<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################################################################################################################</span></span><br><span class="line"><span class="comment"># Create an object store with multisite settings for a production environment. A minimum of 3 hosts with OSDs</span></span><br><span class="line"><span class="comment"># are required in this example.</span></span><br><span class="line"><span class="comment">#################################################################################################################</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephObjectRealm</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.realm</span>&#125;&#125;</span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephObjectZoneGroup</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.zonegroup</span>&#125;&#125;</span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">realm:</span> &#123;&#123;<span class="string">.Values.oss.multisite.realm</span>&#125;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephObjectZone</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.zone</span>&#125;&#125;</span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">zoneGroup:</span> &#123;&#123;<span class="string">.Values.oss.multisite.zonegroup</span>&#125;&#125;</span><br><span class="line"><span class="attr">metadataPool:</span></span><br><span class="line">    <span class="attr">failureDomain:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">replicated:</span></span><br><span class="line">    <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.oss.multisite.replicated</span>&#125;&#125;</span><br><span class="line">    <span class="comment">#requireSafeReplicaSize: true</span></span><br><span class="line"><span class="attr">dataPool:</span></span><br><span class="line">    <span class="attr">failureDomain:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">replicated:</span></span><br><span class="line">    <span class="attr">size:</span> &#123;&#123;<span class="string">.Values.oss.multisite.replicated</span>&#125;&#125;</span><br><span class="line">    <span class="comment">#requireSafeReplicaSize: true</span></span><br><span class="line">    <span class="attr">deviceClass:</span> <span class="string">hdd</span></span><br><span class="line">    <span class="attr">parameters:</span></span><br><span class="line">    <span class="attr">compression_mode:</span> <span class="string">none</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">ceph.rook.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CephObjectStore</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.storeName</span>&#125;&#125;</span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span> <span class="comment"># namespace:cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">port:</span> &#123;&#123;<span class="string">.Values.oss.multisite.port</span>&#125;&#125;</span><br><span class="line">    <span class="comment"># securePort: 443</span></span><br><span class="line">    <span class="attr">instances:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">zone:</span></span><br><span class="line">    <span class="comment"># do not change it, pool name</span></span><br><span class="line">    <span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.zone</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.storeName</span>&#125;&#125;<span class="string">-svc</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line">    <span class="attr">rgw:</span> <span class="string">ar-store-multisite</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.oss.multisite.nodePort</span> &#125;&#125;</span><br><span class="line"><span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> &#123;&#123;<span class="string">.Values.oss.multisite.port</span>&#125;&#125;</span><br><span class="line">    &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.oss.multisite.nodePort</span> &#125;&#125;</span><br><span class="line">    <span class="attr">nodePort:</span> &#123;&#123; <span class="string">.Values.oss.multisite.nodePort</span> &#125;&#125;</span><br><span class="line">    &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.oss.multisite.ingress.enabled</span> &#125;&#125;    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.storeName</span>&#125;&#125;</span><br><span class="line"><span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">ingressClassName:</span> &#123;&#123;<span class="string">.Values.oss.multisite.ingress.ingressClass</span>&#125;&#125;</span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> &#123;&#123;<span class="string">.Values.oss.multisite.ingress.hostName</span>&#125;&#125;</span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">        <span class="attr">service:</span>            </span><br><span class="line">            <span class="attr">name:</span> &#123;&#123;<span class="string">.Values.oss.multisite.storeName</span>&#125;&#125;<span class="string">-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">            <span class="attr">number:</span> &#123;&#123;<span class="string">.Values.oss.multisite.port</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure></li>
<li>manual configurations of the realm to update the crush rule to support creation of different types of buckets<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use ceph-tools execute ceph commands</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n rook-ceph rook-ceph-tools-769bdf4bdd-hdx6r bash</span><br><span class="line"><span class="comment"># create a placement target in zonegroup</span></span><br><span class="line">$ radosgw-admin zonegroup placement list</span><br><span class="line">$ radosgw-admin zonegroup placement add --rgw-zonegroup zonegroup-a --placement-id test-placement --tags test-placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># set placement pools of test-placement (index and data)</span></span><br><span class="line">$ radosgw-admin zone placement add --rgw-zone zone-a --placement-id test-placement --index-pool zone-a.rgw.buckets.test.index --data-pool zone-a.rgw.buckets.test.data --data-extra-pool zone-a.rgw.buckets.test.non-ec</span><br><span class="line"></span><br><span class="line"><span class="comment"># create crush rule</span></span><br><span class="line">$ ceph osd crush rule create-replicated replicated_ssd default host ssd</span><br><span class="line"></span><br><span class="line"><span class="comment"># create placement pools for ssd-placement</span></span><br><span class="line">$ ceph osd pool create zone-a.rgw.buckets.test.index 8 8</span><br><span class="line">$ ceph osd pool create zone-a.rgw.buckets.test.data 8 8</span><br><span class="line">$ ceph osd pool create zone-a.rgw.buckets.test.non-ec 8 8</span><br><span class="line"></span><br><span class="line"><span class="comment"># apply crush rule to newly create pools for ssd-placement</span></span><br><span class="line">$ ceph osd pool <span class="built_in">set</span> zone-a.rgw.buckets.test.index crush_rule replicated_ssd</span><br><span class="line">$ ceph osd pool <span class="built_in">set</span> zone-a.rgw.buckets.test.data crush_rule replicated_ssd</span><br><span class="line">$ ceph osd pool <span class="built_in">set</span> zone-a.rgw.buckets.test.non-ec crush_rule replicated_ssd</span><br><span class="line"></span><br><span class="line"><span class="comment"># add placement tag for default-placement (be default, it&#x27;s not set, be used for creating bucket)</span></span><br><span class="line">$ radosgw-admin zonegroup placement modify --rgw-zonegroup zonegroup-a --placement-id default-placement --tags default-placement</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable the user to create bucket on test-placement</span></span><br><span class="line">$ radosgw-admin user create --uid yuanjing --display-name <span class="string">&quot;Yuanjing&quot;</span> --rgw-realm=realm-a --rgw-zonegroup=zonegroup-a</span><br><span class="line">$ radosgw-admin metadata get user:yuanjing &gt; yuanjing.json</span><br><span class="line"><span class="comment"># add &quot;placement_tags&quot;: [&quot;default-placement&quot;, &quot;test-placement&quot;]</span></span><br><span class="line">$ radosgw-admin metadata put user:yuanjing &lt; yuanjing.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable the update</span></span><br><span class="line">radosgw-admin period update --commit --rgw-realm=realm-a --rgw-zonegroup=zonegroup-a</span><br></pre></td></tr></table></figure></li>
<li>operate on a bucket<ul>
<li>configure s5cmd  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># configure for s5cmd</span></span><br><span class="line">cat &gt; ~/.aws/credentials &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[default]</span></span><br><span class="line"><span class="string">aws_access_key_id = ESYOVEPAMYMR4WM86FFR</span></span><br><span class="line"><span class="string">aws_secret_access_key = xdujJER3kVt1DM5irnQvexXcF35NRjJg40hBdM4Z</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
<li>create a bucket<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s5cmd mb default-placement-bucket</span><br></pre></td></tr></table></figure></li>
<li>delete a bucket  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># remove bucket</span></span><br><span class="line">radosgw-admin bucket rm --bucket=default-placement-bucket --purge-objects</span><br></pre></td></tr></table></figure></li>
<li>create bucket with placement  <figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">bucket = <span class="string">&quot;test-bucket&quot;</span></span><br><span class="line"><span class="comment"># location = &quot;zonegroup:placement-tag&quot;</span></span><br><span class="line">location = <span class="string">&quot;zonegroup-a:test-placement&quot;</span></span><br><span class="line"></span><br><span class="line">s3 = boto3.client(</span><br><span class="line">    <span class="string">&#x27;s3&#x27;</span>,</span><br><span class="line">    endpoint_url=<span class="string">&quot;http://10.0.2.4:8080&quot;</span>,</span><br><span class="line">    aws_access_key_id=<span class="string">&quot;VKOCRRX0PBCGG1SNXXVB&quot;</span>,</span><br><span class="line">    aws_secret_access_key=<span class="string">&quot;cw4Z2zxYY56d6iqax8aUifJa0Wf654Nwsmiz6HU0&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">s3.create_bucket(</span><br><span class="line">    Bucket=bucket,</span><br><span class="line">    CreateBucketConfiguration=&#123;<span class="string">&#x27;LocationConstraint&#x27;</span>: location&#125;,</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Deploy-MINIO-GUI-for-Ceph-Obkect-Storage"><a href="#Deploy-MINIO-GUI-for-Ceph-Obkect-Storage" class="headerlink" title="Deploy MINIO GUI for Ceph Obkect Storage"></a>Deploy MINIO GUI for Ceph Obkect Storage</h5><ul>
<li>Deployment</li>
<li>PersistentVolumeClaim (for storage of GUI users)</li>
<li>Service</li>
<li>Ingress<br>Fill the templates accroding to your setup<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">and</span> <span class="string">.Values.oss.multisite.dashboard.enabled</span> <span class="string">.Values.oss.multisite.ingress.enabled</span>&#125;&#125;  </span><br><span class="line"><span class="comment"># https://medium.com/techlogs/mino-s3-gateway-gui-for-rook-ceph-s3-93a8b4c7040b </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-oss-minio-gw</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ceph-oss-minio-gw</span></span><br><span class="line">    <span class="attr">purpose:</span> <span class="string">ceph-oss-mino-UI</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ceph-oss-minio-gw</span></span><br><span class="line">      <span class="attr">purpose:</span> <span class="string">ceph-oss-mino-UI</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ceph-oss-minio-gw</span></span><br><span class="line">        <span class="attr">purpose:</span> <span class="string">ceph-oss-mino-UI</span></span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-oss-minio-gw</span></span><br><span class="line">        <span class="attr">image:</span> &#123;&#123;<span class="string">.Values.oss.multisite.dashboard.image</span>&#125;&#125;</span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">minio</span> <span class="string">gateway</span> <span class="string">s3</span> <span class="string">http://rook-ceph-rgw-&#123;&#123;.Values.oss.multisite.storeName&#125;&#125;:8080</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">        <span class="comment">#command: [&quot;/bin/sh&quot;] </span></span><br><span class="line">        <span class="comment">#args: [&quot;minio gateway s3 http://s3.mystore.10.x.y.112.nip.io:80&quot;]</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9001</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_ACCESS_KEY</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123;<span class="string">.Values.oss.multisite.dashboard.admin</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_SECRET_KEY</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123;<span class="string">.Values.oss.multisite.dashboard.adminPassword</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_ETCD_ENDPOINTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">http://localhost:2379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MINIO_ETCD_PATH_PREFIX</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">minio/</span></span><br><span class="line">      <span class="comment"># https://programming.vip/docs/a-little-problem-in-building-minio-gateway.html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">etcd</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.io/bitnami/etcd:3.5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2379</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ALLOW_NONE_AUTHENTICATION</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;yes&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/bitnami/etcd</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">etcd-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">etcd-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">ceph-oss-minio-gw-etcd</span></span><br><span class="line"><span class="meta">---  </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-oss-minio-gw-etcd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> &#123;&#123; <span class="string">.Values.oss.multisite.dashboard.persistence.size</span> &#125;&#125;</span><br><span class="line">  <span class="attr">storageClassName:</span> &#123;&#123; <span class="string">.Values.oss.multisite.dashboard.persistence.storageClass</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-oss-minio-gw-svc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">ceph-oss-minio-gw</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.oss.multisite.dashboard.nodePort</span> &#125;&#125;</span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">9001</span></span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.oss.multisite.dashboard.nodePort</span> &#125;&#125;</span><br><span class="line">      <span class="attr">nodePort:</span> &#123;&#123; <span class="string">.Values.oss.multisite.dashboard.nodePort</span> &#125;&#125;</span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-oss-minio-gw-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rook-ceph</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> &#123;&#123;<span class="string">.Values.oss.multisite.dashboard.ingress.ingressClass</span>&#125;&#125;</span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> &#123;&#123;<span class="string">.Values.oss.multisite.dashboard.ingress.hostName</span>&#125;&#125;</span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span>            </span><br><span class="line">            <span class="attr">name:</span> <span class="string">ceph-oss-minio-gw-svc</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Cleanup-rook-ceph"><a href="#Cleanup-rook-ceph" class="headerlink" title="Cleanup rook-ceph"></a>Cleanup rook-ceph</h2><ul>
<li><p>first clean up all the resources in use, and the down the ceph cluster</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cleanup resources</span></span><br><span class="line">kubectl delete obc -A</span><br><span class="line">kubectl delete pvc -A</span><br><span class="line"><span class="comment"># down the ceph cluster</span></span><br><span class="line">helmfile -f helmfile.yaml -e k8s01 -l bundle=rook-ceph destroy</span><br></pre></td></tr></table></figure></li>
<li><p>cleanup on the host</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/lib/rook/*</span><br></pre></td></tr></table></figure></li>
<li><p>cleanup osd device and reboot</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># unformat the disk device</span></span><br><span class="line">DISK=<span class="string">&quot;/dev/sdc&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ ! -z <span class="variable">$1</span> ];<span class="keyword">then</span></span><br><span class="line">DISK=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)</span></span><br><span class="line"><span class="comment"># You will have to run this step for all disks.</span></span><br><span class="line">sgdisk --zap-all <span class="variable">$DISK</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="string">&quot;<span class="variable">$DISK</span>&quot;</span> bs=1M count=100 oflag=direct,dsync</span><br></pre></td></tr></table></figure></li>
<li><p>these steps only have to be run once on each node. If rook sets up osds using ceph-volume, teardown leaves some devices mapped that lock the disks.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls /dev/mapper/ceph-xxx | xargs -I% -- dmsetup remove %</span><br><span class="line"><span class="comment"># ceph-volume setup can leave ceph-&lt;UUID&gt; directories in /dev (unnecessary clutter)</span></span><br><span class="line">rm -rf /dev/ceph-xxx</span><br><span class="line"><span class="comment"># check</span></span><br><span class="line">lsblk -f</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Trouble-shooting-ceph-installation"><a href="#Trouble-shooting-ceph-installation" class="headerlink" title="Trouble shooting ceph installation"></a>Trouble shooting ceph installation</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check why osd is not up</span></span><br><span class="line">kubectl -n rook-ceph logs rook-ceph-osd-prepare-node01--1-wnq6d provision</span><br></pre></td></tr></table></figure>
<h2 id="Usage-1"><a href="#Usage-1" class="headerlink" title="Usage"></a>Usage</h2><h3 id="ceph-osd-pool-management"><a href="#ceph-osd-pool-management" class="headerlink" title="ceph osd: pool management"></a>ceph osd: pool management</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># delete pool</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">pool_list=<span class="string">&quot;.rgw.root zone-muc.rgw.control ar-store.rgw.control zone-muc.rgw.meta ar-store.rgw.meta zone-muc.rgw.log ar-store.rgw.log ar-store.rgw.buckets.index zone-muc.rgw.buckets.index zone-muc.rgw.buckets.non-ec ar-store.rgw.buckets.non-ec zone-muc.rgw.buckets.data ar-store.rgw buckets.data default.rgw.log default.rgw.control default.rgw.meta&quot;</span></span><br><span class="line"><span class="keyword">for</span> pool <span class="keyword">in</span> <span class="variable">$pool_list</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  ceph osd pool rm <span class="variable">$pool</span> <span class="variable">$pool</span> --yes-i-really-really-mean-it</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check storage of each pool</span></span><br><span class="line">ceph df</span><br><span class="line"><span class="comment"># details of a pool</span></span><br><span class="line">ceph osd pool ls detail</span><br></pre></td></tr></table></figure>

<h3 id="ceph-filesystem"><a href="#ceph-filesystem" class="headerlink" title="ceph filesystem"></a>ceph filesystem</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check status</span></span><br><span class="line">ceph fs status</span><br><span class="line"><span class="comment"># check available filesystem</span></span><br><span class="line">ceph fs ls</span><br><span class="line"><span class="comment"># check pg and osd</span></span><br><span class="line">ceph pg dump pgs|awk <span class="string">&#x27;&#123;print $1,$2,$16&#125;&#x27;</span></span><br><span class="line"><span class="comment">#first column, pg id (the first part is the pool id)</span></span><br><span class="line"><span class="comment">#second column: number of objects</span></span><br><span class="line"><span class="comment">#third column: osds</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#when we increase pg, the objects in current pgs will split into new pg (still use the same osds) -&gt; the objects are not rebalanced</span></span><br><span class="line"><span class="comment">#when we increase pgp, the objects are rebalanced on osds</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check crush rule</span></span><br><span class="line">ceph osd crush rule dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># in k8s there should be csi created by provisioner</span></span><br><span class="line">ceph fs subvolumegroup ls myfs</span><br><span class="line">ceph fs subvolumegroup create myfs csi</span><br><span class="line"></span><br><span class="line"><span class="comment"># set a storageclass to a default</span></span><br><span class="line">kubectl patch storageclass fs-hdd -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remove fs, which are created with commandline tool</span></span><br><span class="line"><span class="comment">## down the fs</span></span><br><span class="line">ceph fs fail cephfs-demo</span><br><span class="line"><span class="comment">## remove the fs</span></span><br><span class="line">ceph fs rm cephfs-demo --yes-i-really-mean-it</span><br><span class="line"><span class="comment">## remove the pools</span></span><br><span class="line">ceph osd lspools</span><br><span class="line">ceph osd pool rm cephfs_data cephfs_data --yes-i-really-really-mean-it</span><br><span class="line"><span class="comment"># the above will raise error</span></span><br><span class="line"><span class="comment"># Error EPERM: pool deletion is disabled; you must first set the mon_allow_pool_delete config option to true before you can destroy a pool</span></span><br><span class="line">ceph tell mon.\* injectargs <span class="string">&#x27;--mon-allow-pool-delete=true&#x27;</span></span><br><span class="line"></span><br><span class="line">ceph osd pool rm cephfs_data cephfs_data --yes-i-really-really-mean-it</span><br><span class="line">ceph osd pool rm cephfs_metadata cephfs_metadata --yes-i-really-really-mean-it</span><br></pre></td></tr></table></figure>

<h3 id="ceph-osd-remove-a-osd-device"><a href="#ceph-osd-remove-a-osd-device" class="headerlink" title="ceph osd: remove a osd device"></a>ceph osd: remove a osd device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.icode9.com/content-4-1244528.html</span></span><br><span class="line"><span class="comment"># stop operator</span></span><br><span class="line">kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=0 </span><br><span class="line"><span class="comment"># edit cluster to remove the osd</span></span><br><span class="line">kubectl edit cephclusters.ceph.rook.io -n rook-ceph rook-ceph </span><br><span class="line"></span><br><span class="line"><span class="comment"># use ceph-tools to down the osd</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it -n rook-ceph rook-ceph-tools-769bdf4bdd-hdx6r bash</span><br><span class="line">ceph osd <span class="built_in">set</span> noup</span><br><span class="line">ceph osd down 0</span><br><span class="line">ceph osd out 0</span><br><span class="line"><span class="comment"># check rebalancing status</span></span><br><span class="line">ceph -w</span><br><span class="line"></span><br><span class="line"><span class="comment"># when rebalancing finished, delete osd</span></span><br><span class="line">ceph osd purge 0 --yes-i-really-mean-it</span><br><span class="line">ceph auth del osd.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove the host from crushmap when there is no osd on that host</span></span><br><span class="line">ceph osd crush remove host-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># check status</span></span><br><span class="line">ceph -s</span><br><span class="line">ceph osd tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlabel</span></span><br><span class="line">ceph osd <span class="built_in">unset</span> noup</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete osd job </span></span><br><span class="line">kubectl delete deploy -n rook-ceph rook-ceph-osd-0</span><br><span class="line"></span><br><span class="line"><span class="comment"># restart operator</span></span><br><span class="line">kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=1</span><br></pre></td></tr></table></figure>

<h3 id="ceph-osd-add-a-new-osd"><a href="#ceph-osd-add-a-new-osd" class="headerlink" title="ceph osd: add a new osd"></a>ceph osd: add a new osd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stop operator</span></span><br><span class="line">kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=0 </span><br><span class="line"><span class="comment"># edit cluster to add the osd</span></span><br><span class="line">kubectl edit cephclusters.ceph.rook.io -n rook-ceph rook-ceph</span><br><span class="line"><span class="comment"># restart operator</span></span><br><span class="line">kubectl -n rook-ceph scale deployment rook-ceph-operator --replicas=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="comment"># edit helmfile the osd, and apply</span></span><br></pre></td></tr></table></figure>

<h3 id="ceph-object-storage-data-pools"><a href="#ceph-object-storage-data-pools" class="headerlink" title="ceph object storage: data pools"></a>ceph object storage: data pools</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a CephObjectStore</span></span><br><span class="line">kubectl apply -f os.yaml</span><br><span class="line"><span class="comment"># after creating CephObjectStore, the following pool will be created</span></span><br><span class="line"><span class="comment"># realm: my-store, zonegroup: my-store, zone: my-store</span></span><br><span class="line">12 my-store.rgw.control</span><br><span class="line">13 my-store.rgw.meta</span><br><span class="line">14 my-store.rgw.log</span><br><span class="line">15 my-store.rgw.buckets.index</span><br><span class="line">16 my-store.rgw.buckets.non-ec</span><br><span class="line">17 .rgw.root</span><br><span class="line">18 my-store.rgw.buckets.data</span><br><span class="line"></span><br><span class="line"><span class="comment"># based on above buckets</span></span><br><span class="line"><span class="comment"># sc for auto generating bucket (this is already included in rook-ceph-resources)</span></span><br><span class="line">kubectl apply -f os_sc.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># claim a bucket</span></span><br><span class="line">kubectl apply -f os_bucket.yaml</span><br></pre></td></tr></table></figure>

<h3 id="ceph-object-storage-multisite-management"><a href="#ceph-object-storage-multisite-management" class="headerlink" title="ceph object storage: multisite management"></a>ceph object storage: multisite management</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get and set zonegroup info</span></span><br><span class="line">radosgw-admin zonegroup get --rgw-zonegroup=zonegroup-a &gt; zonegroup_a.json</span><br><span class="line">radosgw-admin zonegroup <span class="built_in">set</span> --infile ./zonegroup_a.json</span><br><span class="line"><span class="comment"># enable update</span></span><br><span class="line">radosgw-admin period update --commit --rgw-realm=realm-a --rgw-zonegroup=zonegroup-a</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove realm, zonegroup, zone</span></span><br><span class="line"><span class="comment"># radosgw-admin zonegroup remove --rgw-zonegroup=default --rgw-zone=default</span></span><br><span class="line"><span class="comment"># radosgw-admin period update --commit</span></span><br><span class="line"><span class="comment"># radosgw-admin zone rm --rgw-zone=default</span></span><br><span class="line"><span class="comment"># radosgw-admin period update --commit</span></span><br><span class="line"><span class="comment"># radosgw-admin zonegroup delete --rgw-zonegroup=default</span></span><br><span class="line"><span class="comment"># radosgw-admin period update --commit</span></span><br></pre></td></tr></table></figure>

<h3 id="ceph-object-storage-user-management"><a href="#ceph-object-storage-user-management" class="headerlink" title="ceph object storage: user management"></a>ceph object storage: user management</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a user (in a zonegroup)</span></span><br><span class="line">$ radosgw-admin user create --uid yuanjing --display-name <span class="string">&quot;Yuanjing&quot;</span> --rgw-realm=realm-a --rgw-zonegroup=zonegroup-a</span><br><span class="line"><span class="comment"># edit user</span></span><br><span class="line">$ radosgw-admin metadata get user:yuanjing --rgw-realm=realm-a --rgw-zonegroup=zonegroup-a &gt; yuanjing.json</span><br><span class="line"><span class="comment"># add something in yuanjing.json and apply the change</span></span><br><span class="line">$ radosgw-admin metadata put user:yuanjing --rgw-realm=realm-a --rgw-zonegroup=zonegroup-a &lt; yuanjing.json</span><br></pre></td></tr></table></figure>

<h3 id="ceph-object-storage-bucket-policy"><a href="#ceph-object-storage-bucket-policy" class="headerlink" title="ceph object storage: bucket policy"></a>ceph object storage: bucket policy</h3><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/radosgw/bucketpolicy/">https://docs.ceph.com/en/latest/radosgw/bucketpolicy/</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a1aab0d3eeef">https://www.jianshu.com/p/a1aab0d3eeef</a><br><a target="_blank" rel="noopener" href="https://zhoubofsy.github.io/2019/10/17/storage/ceph/rgw-bucket-policy/">https://zhoubofsy.github.io/2019/10/17/storage/ceph/rgw-bucket-policy/</a><br><a target="_blank" rel="noopener" href="https://www.modb.pro/db/134277">https://www.modb.pro/db/134277</a><br>example policies</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>:</span><br><span class="line">    <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [&#123;</span><br><span class="line">        <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;AddPerm&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Principal&quot;</span>: &#123;<span class="attr">&quot;AWS&quot;</span>: [<span class="string">&quot;*&quot;</span>]&#125;,</span><br><span class="line">        <span class="attr">&quot;Action&quot;</span>: [<span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s3:DeleteObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span>],</span><br><span class="line">        <span class="attr">&quot;Resource&quot;</span>: [<span class="string">&quot;arn:aws:s3:::my-new-bucket&quot;</span>, <span class="string">&quot;arn:aws:s3:::my-new-bucket/*&quot;</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>:</span><br><span class="line">    <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [&#123;</span><br><span class="line">        <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;AddPerm&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Principal&quot;</span>: &#123;<span class="attr">&quot;AWS&quot;</span>: [<span class="string">&quot;arn:aws:iam:::user/yuanjing&quot;</span>,<span class="string">&quot;arn:aws:iam::tenanttwo:user/userthree&quot;</span>]&#125;,</span><br><span class="line">        <span class="attr">&quot;Action&quot;</span>: [<span class="string">&quot;s3:ListBucket&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s3:PutObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s3:DeleteObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;s3:GetObject&quot;</span>],</span><br><span class="line">        <span class="attr">&quot;Resource&quot;</span>: [<span class="string">&quot;arn:aws:s3:::my-new-bucket&quot;</span>, <span class="string">&quot;arn:aws:s3:::my-new-bucket/*&quot;</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;</span>:</span><br><span class="line">    <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span>: [&#123;</span><br><span class="line">        <span class="attr">&quot;Sid&quot;</span>: <span class="string">&quot;AddPerm&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Effect&quot;</span>: <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;Principal&quot;</span>: &#123;<span class="attr">&quot;AWS&quot;</span>: [<span class="string">&quot;arn:aws:iam:::user/yuanjing&quot;</span>,<span class="string">&quot;arn:aws:iam::tenanttwo:user/userthree&quot;</span>]&#125;,</span><br><span class="line">        <span class="attr">&quot;Action&quot;</span>: [<span class="string">&quot;s3:*&quot;</span>],</span><br><span class="line">        <span class="attr">&quot;Resource&quot;</span>: [<span class="string">&quot;arn:aws:s3:::my-new-bucket&quot;</span>, <span class="string">&quot;arn:aws:s3:::my-new-bucket/*&quot;</span>]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># To apply the policy on a bucket with s3cmd</span></span><br><span class="line">s3cmd setpolicy policy.json s3://my-new-bucket</span><br></pre></td></tr></table></figure>

<h3 id="ceph-dashboard"><a href="#ceph-dashboard" class="headerlink" title="ceph dashboard"></a>ceph dashboard</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user: admin</span><br><span class="line">password: kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=<span class="string">&quot;&#123;[&#x27;data&#x27;][&#x27;password&#x27;]&#125;&quot;</span> | base64 --decode &amp;&amp; <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># enable object gateway in dashboard</span></span><br><span class="line">https://github.com/rook/rook/issues/3026</span><br><span class="line">ceph dashboard set-rgw-api-access-key -i access_key</span><br><span class="line">ceph dashboard set-rgw-api-secret-key -i PATH_TO_FILE</span><br></pre></td></tr></table></figure>


<h2 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h2><ol>
<li><p><a target="_blank" rel="noopener" href="https://kuboard.cn/learning/k8s-intermediate/persistent/ceph/rook-config.html#%E5%AE%89%E8%A3%85-rook-ceph">https://kuboard.cn/learning/k8s-intermediate/persistent/ceph/rook-config.html#%E5%AE%89%E8%A3%85-rook-ceph</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.joyk.com/dig/detail/1585287051590150">https://www.joyk.com/dig/detail/1585287051590150</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/deploy-ceph-cluster-with-rook/">https://www.qikqiak.com/post/deploy-ceph-cluster-with-rook/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-a-ceph-cluster-within-kubernetes-using-rook">https://www.digitalocean.com/community/tutorials/how-to-set-up-a-ceph-cluster-within-kubernetes-using-rook</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xiebiao.top/post/storage/rook_install_operator/">https://xiebiao.top/post/storage/rook_install_operator/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/rook/rook/tree/master/cluster/examples">https://github.com/rook/rook/tree/master/cluster/examples</a></p>
</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cloud/" rel="tag"><i class="fa fa-tag"></i> cloud</a>
              <a href="/tags/ceph/" rel="tag"><i class="fa fa-tag"></i> ceph</a>
              <a href="/tags/rook-ceph/" rel="tag"><i class="fa fa-tag"></i> rook-ceph</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/10/05/cephadm/" rel="prev" title="Install ceph with cephadm">
                  <i class="fa fa-chevron-left"></i> Install ceph with cephadm
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/02/06/helmchart/" rel="next" title="helm charts">
                  helm charts <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuanjing Liu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>Symbols count total: </span>
    <span title="Symbols count total">93k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>Reading time total &asymp;</span>
    <span title="Reading time total">1:25</span>
  </span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
